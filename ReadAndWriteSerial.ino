// #include <ThingSpeak.h>

#include <SoftwareSerial.h>

SoftwareSerial gprsSerial(10,11);
 
#include <String.h>
 
void setup()
{
  gprsSerial.begin(9600);               // the GPRS baud rate   
  Serial.begin(9600);    // the GPRS baud rate 
 
  //delay(1000);
}
 
void loop()
{
  if (gprsSerial.available())
    Serial.write(gprsSerial.read());
 
  gprsSerial.println("AT");
  delay(1000);
 
  gprsSerial.println("AT+CPIN?");
  delay(1000);
 
  gprsSerial.println("AT+CREG?");
  delay(1000);
 
  gprsSerial.println("AT+CGATT?");
  delay(1000);
 
  gprsSerial.println("AT+CIPSHUT");
  delay(1000);
 
  gprsSerial.println("AT+CIPSTATUS");
  delay(2000);
 
  gprsSerial.println("AT+CIPMUX=0");
  delay(2000);
 
  ShowSerialData();
 
  gprsSerial.println("AT+CSTT=\"m2mglobal\"");//start task and setting the APN,
  delay(1000);
 
  ShowSerialData();
 
  gprsSerial.println("AT+CIICR");//bring up wireless connection
  delay(3000);
 
  ShowSerialData();
 
  gprsSerial.println("AT+CIFSR");//get local IP adress
  delay(2000);
 
  ShowSerialData();
 
  gprsSerial.println("AT+CIPSPRT=0");
  delay(3000);
 
  ShowSerialData();
  
  gprsSerial.println("AT+CIPSTART=\"TCP\",\"api.thingspeak.com\",\"80\"");//start up the connection
  delay(6000);
 
  ShowSerialData();
 
  gprsSerial.println("AT+CIPSEND");//begin send data to remote server
  delay(4000);
  ShowSerialData();
  
  //String str="GET https://api.thingspeak.com/update?api_key=6045WJVT56ZL6SKA&field1=11";  //write data to thingspeak
  String str="GET https://api.thingspeak.com/channels/1808792/fields/1.json?api_key=RPKW7O2GQTV0CRG2&results=2";  //read data from thingspeak
  Serial.println(str);
  gprsSerial.println(str);//begin send data to remote server
  //delay(1000);
  //long temp = ThingSpeak.readLongField(1808792, 1, "RPKW7O2GQTV0CRG2");
  //Serial.println(temp);
  
 ReadGSMRXData();

 delay(5000);//waitting for reply, important! the time is base on the condition of internet 
 
  gprsSerial.println((char)26);//sending
  gprsSerial.println();
 
  ReadGSMRXData();
 
  gprsSerial.println("AT+CIPSHUT");//close the connection
  delay(100);
  ShowSerialData();
} 
void ShowSerialData()
{
  while(gprsSerial.available()!=0)
  Serial.write(gprsSerial.read());
  delay(5000); 
  
}
void ReadGSMRXData() {
  //Available data is known to be in the RX buffer
  //Read it and return via G_GSMRXData
  //Application wide this is the only place we do Serial1.read()
  unsigned long l_timer = millis();
  while (millis()-l_timer<=2000) {
    while (gprsSerial.available()) {
      char l_char; //Always read a char, then append char to G_GSMRXData String
      l_char = gprsSerial.read();
      Serial.write(l_char);
      l_timer = millis(); //reset qtr sec timer
    }
  }
  delay(2000);
  
} 
